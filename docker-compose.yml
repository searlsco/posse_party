x-app-env: &app-env
  env_file:
    - .env

services:
  db:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - db_data:/var/lib/postgresql/data

  migrate:
    image: ${POSSE_IMAGE:-ghcr.io/searlsco/posse_party:latest}
    <<: *app-env
    depends_on:
      db:
        condition: service_healthy
    command: ["./script/release"]
    restart: "no"

  web:
    image: ${POSSE_IMAGE:-ghcr.io/searlsco/posse_party:latest}
    restart: unless-stopped
    <<: *app-env
    command: ["./script/server"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000/up || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    stdin_open: true
    tty: true

  worker:
    image: ${POSSE_IMAGE:-ghcr.io/searlsco/posse_party:latest}
    restart: unless-stopped
    <<: *app-env
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    command: ["./script/worker"]
    healthcheck:
      test: [
        "CMD-SHELL",
        "./bin/rails runner 'exit(SolidQueue::Process.where(\"last_heartbeat_at > ?\", SolidQueue.process_alive_threshold.ago).exists? ? 0 : 1)'"
      ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  caddy:
    image: caddy:latest
    restart: unless-stopped
    environment:
      APP_HOST: ${APP_HOST}
      APP_PRIVATE_HOST: ${APP_PRIVATE_HOST:-false}
    depends_on:
      web:
        condition: service_started
    ports:
      - "${APP_HTTP_PORT:-80}:80"
      - "${APP_HTTPS_PORT:-443}:443"
    command: >
      sh -c '
        is_ip() {
          case "$1" in
            *:*) printf "%s" "$1" | grep -Eq "^[0-9a-fA-F:]+$" ;;
            *.*) printf "%s" "$1" | grep -Eq "^([0-9]{1,3}\.){3}[0-9]{1,3}$" ;;
            *) return 1 ;;
          esac
        }

        {
          echo ":80 {";
          echo "  reverse_proxy web:3000";
          echo "}";
          if [ -n "$APP_HOST" ]; then
            if [ "${APP_PROTOCOL:-}" = "http" ] || { [ "${APP_PRIVATE_HOST:-false}" != "true" ] && is_ip "$APP_HOST"; }; then
              echo "http://$APP_HOST:80 {";
              echo "  reverse_proxy web:3000";
              echo "}";
            elif [ "${APP_PRIVATE_HOST:-false}" = "true" ]; then
              echo "$APP_HOST {";
              echo "  reverse_proxy web:3000";
              echo "  tls internal";
              echo "}";
            else
              echo "$APP_HOST {";
              echo "  reverse_proxy web:3000";
              echo "}";
            fi
          fi
        } > /etc/caddy/Caddyfile
        exec caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
      '
    volumes:
      - proxy_data:/data

volumes:
  db_data:
  proxy_data:
